import{_ as ae}from"./logo-Dp76uQSX.js";import{_ as se,u as te,r as i,j as F,o as le,a as re,c as T,b as t,t as A,d as o,w as a,k as ne,e as l,f as b,l as u,m as de,g as p,n as ue,s as ce,p as ie,q as pe,v as me,x as $,y as fe,z as _e,A as ve,B as ge,h as we,E as g}from"./index-xsXBKXXp.js";import{b as ye,c as he,u as ke,m as j,d as be,g as Ve}from"./md5-DKd9LonJ.js";const Ce={class:"home-container"},xe={class:"header"},Ue={class:"user-section"},Be={class:"storage-info"},Pe={class:"storage-text"},Se={class:"user-info"},Me={class:"nickname"},Ie={class:"layout"},Ae={class:"sidebar"},Ne={class:"main-content"},Re={class:"verify-code-container"},qe={class:"verify-code-img"},Ee=["src"],Fe={class:"dialog-footer"},Te=["src"],$e={class:"dialog-footer"},je={__name:"Home",setup(De){const D=ge(),L=we(),w=te(),m=w.userInfo,V=i(0),y=i(0),C=F(()=>{if(!y.value)return 0;const s=Math.round(V.value/y.value*100);return Math.min(s,100)}),N=s=>{if(!s)return"0 B";const e=["B","KB","MB","GB","TB"];let n=0,v=s;for(;v>=1024&&n<e.length-1;)v/=1024,n++;return`${v.toFixed(2)} ${e[n]}`},R=async()=>{try{const s=await ye();s.code===1&&s.data&&(V.value=Number(s.data.userSpace||0),y.value=Number(s.data.totalSpace||0))}catch(s){console.error("获取用户空间信息失败:",s)}};le(async()=>{await R()});const f=i(!1),x=i(null),U=i(!1),q=i(""),r=re({oldPassword:"",password:"",checkCode:""}),z={oldPassword:[{required:!0,message:"请输入原密码",trigger:"blur"}],password:[{required:!0,message:"请输入新密码",trigger:"blur"},{min:6,message:"密码长度不能小于6位",trigger:"blur"}],checkCode:[{required:!0,message:"请输入验证码",trigger:"blur"}]},H=async()=>{try{const s=await Ve(1),e=new Blob([s],{type:"image/jpeg"});return URL.createObjectURL(e)}catch(s){return console.error("获取验证码失败:",s),""}},B=async()=>{q.value=await H()},_=i(!1),h=i(""),G=async s=>{switch(s){case"updatePassword":f.value=!0,B();break;case"updateAvatar":_.value=!0,h.value=m.avatar;break;case"logout":try{await ne.confirm("确定要退出登录吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await he(),w.clearUserInfo(),L.push("/login")}catch{}break}},K=async()=>{x.value&&await x.value.validate(async s=>{if(s)try{U.value=!0,(await ke({oldPassword:j(r.oldPassword),password:j(r.password),checkCode:r.checkCode})).code===1&&(g.success("修改密码成功"),f.value=!1,r.oldPassword="",r.password="",r.checkCode="")}catch{B()}finally{U.value=!1}})},O=s=>{const e=s.type.startsWith("image/"),n=s.size/1024/1024<2;return e?n?!0:(g.error("图片大小不能超过 2MB!"),!1):(g.error("只能上传图片文件!"),!1)},W=async({file:s})=>{try{const e=await be(s);if(e.code===1){const n=e.msg;console.log("新的头像"+n),h.value=n,m.avatar=n,w.setUserInfo({...m,avatar:n}),g.success("更新头像成功"),_.value=!1}}catch{g.error("更新头像失败，请重试")}},J=F(()=>D.path);return(s,e)=>{const n=l("el-progress"),v=l("el-avatar"),c=l("el-icon"),P=l("el-dropdown-item"),Q=l("el-dropdown-menu"),X=l("el-dropdown"),k=l("el-menu-item"),Y=l("el-menu"),Z=l("router-view"),S=l("el-input"),M=l("el-form-item"),ee=l("el-form"),I=l("el-button"),E=l("el-dialog"),oe=l("el-upload");return b(),T("div",Ce,[t("div",xe,[e[10]||(e[10]=t("div",{class:"logo-container"},[t("img",{src:ae,alt:"logo",class:"logo"}),t("span",{class:"logo-text"},"在线移动网盘")],-1)),t("div",Ue,[t("div",Be,[t("div",Pe,[t("span",null,A(N(V.value)),1),t("span",null,"/"+A(N(y.value)),1)]),o(n,{percentage:C.value,format:()=>"","stroke-width":12,class:"storage-progress",status:C.value>=90?"danger":C.value>=70?"warning":""},null,8,["percentage","status"])]),o(X,{trigger:"hover",onCommand:G},{dropdown:a(()=>[o(Q,null,{default:a(()=>[o(P,{command:"updatePassword"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(de))]),_:1}),e[7]||(e[7]=p("修改密码 "))]),_:1}),o(P,{command:"updateAvatar"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(ue))]),_:1}),e[8]||(e[8]=p("更新头像 "))]),_:1}),o(P,{divided:"",command:"logout"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(ce))]),_:1}),e[9]||(e[9]=p("退出登录 "))]),_:1})]),_:1})]),default:a(()=>[t("div",Se,[o(v,{size:40,src:u(m).avatar||""},null,8,["src"]),t("span",Me,A(u(m).nickName),1)])]),_:1})])]),t("div",Ie,[t("div",Ae,[o(Y,{"default-active":J.value,class:"menu",router:""},{default:a(()=>[o(k,{index:"/home/index"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(ie))]),_:1}),e[11]||(e[11]=t("span",null,"首页",-1))]),_:1}),o(k,{index:"/home/share"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(pe))]),_:1}),e[12]||(e[12]=t("span",null,"分享",-1))]),_:1}),o(k,{index:"/home/recycle"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(me))]),_:1}),e[13]||(e[13]=t("span",null,"回收站",-1))]),_:1}),u(w).userInfo.isAdmin?(b(),$(k,{key:0,index:"/home/setting/users"},{default:a(()=>[o(c,null,{default:a(()=>[o(u(fe))]),_:1}),e[14]||(e[14]=t("span",null,"设置",-1))]),_:1})):_e("",!0)]),_:1},8,["default-active"])]),t("div",Ne,[o(Z,{"update-user-space":R})])]),o(E,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=d=>f.value=d),title:"修改密码",width:"400px","close-on-click-modal":!1},{footer:a(()=>[t("span",Fe,[o(I,{onClick:e[3]||(e[3]=d=>f.value=!1)},{default:a(()=>e[15]||(e[15]=[p("取消")])),_:1}),o(I,{type:"primary",onClick:K,loading:U.value},{default:a(()=>e[16]||(e[16]=[p(" 确认 ")])),_:1},8,["loading"])])]),default:a(()=>[o(ee,{ref_key:"passwordFormRef",ref:x,model:r,rules:z,"label-width":"100px"},{default:a(()=>[o(M,{label:"原密码",prop:"oldPassword"},{default:a(()=>[o(S,{modelValue:r.oldPassword,"onUpdate:modelValue":e[0]||(e[0]=d=>r.oldPassword=d),type:"password","show-password":"",placeholder:"请输入原密码"},null,8,["modelValue"])]),_:1}),o(M,{label:"新密码",prop:"password"},{default:a(()=>[o(S,{modelValue:r.password,"onUpdate:modelValue":e[1]||(e[1]=d=>r.password=d),type:"password","show-password":"",placeholder:"请输入新密码"},null,8,["modelValue"])]),_:1}),o(M,{label:"验证码",prop:"checkCode"},{default:a(()=>[t("div",Re,[o(S,{modelValue:r.checkCode,"onUpdate:modelValue":e[2]||(e[2]=d=>r.checkCode=d),placeholder:"请输入验证码",class:"verify-code-input"},null,8,["modelValue"]),t("div",qe,[t("img",{src:q.value,alt:"验证码",onClick:B},null,8,Ee)])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),o(E,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=d=>_.value=d),title:"更新头像",width:"400px","close-on-click-modal":!1},{footer:a(()=>[t("span",$e,[o(I,{onClick:e[5]||(e[5]=d=>_.value=!1)},{default:a(()=>e[17]||(e[17]=[p("取消")])),_:1})])]),default:a(()=>[o(oe,{class:"avatar-uploader","show-file-list":!1,"before-upload":O,"http-request":W},{default:a(()=>[h.value?(b(),T("img",{key:0,src:h.value,class:"avatar-preview"},null,8,Te)):(b(),$(c,{key:1,class:"avatar-uploader-icon"},{default:a(()=>[o(u(ve))]),_:1}))]),_:1})]),_:1},8,["modelValue"])])}}},Ge=se(je,[["__scopeId","data-v-6eb5750f"]]);export{Ge as default};
